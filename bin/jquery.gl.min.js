(function(u){function v(a,b){return function(c){if(c){var d=this[a];this[a]=function(a){d.apply(this,[a]);c.apply(this,[a])}}else this[a](b);return this}}function r(a){this._models=[];this._gl=a;this._draw=function(){};this.draw=v("_draw",this._gl);this._update=function(){};this.update=v("_update",this._gl);this._frame=function(){this._draw(this._gl);this._update(this._gl)};this.frame=v("_frame",this._gl)}function x(a,b){this._items=b;for(var c in a.prototype)"function"==typeof a.prototype[c]&&this.addFunction(c)}
function m(a){a||alert("Tried to create a material with undefined context.");this._gl=a;this.prog=a.createProgram();this._shaders={};this._uniforms={};this._textures={};this.DefaultMatrix={P:0,M:1,C:2,N:3}}function s(){this._stack=[];this.m=l.I(4);this.p=l.I(4);this.c=l.I(4)}function p(a,b,c,d){a||alert("Tried to create a model with undefined context.");c||alert("Tried to create a model with undefined geometry type.");d||alert("Tried to create a model with undefined length.");this.state=null;this.o=
this.orientation=new s;this.o.perspective=void 0;this._vert_length=d;this._type=c;this._buffers=[];this._gl=a;this._material=b;this._enabled=!0;b||(this._material=a.x.currentMaterial);this._material||alert("Must create a material before you can create a Model.");this._elementArray=null;this._modifiers={};this._update=function(){};this.update=v("_update",this._gl);this.draw=v("_draw",this._gl)}function z(a,b){return function(){a[b].apply(a,arguments);return this}}function t(a,b,c,d,e){this._frame=
0;this._width=b;this._height=c;this._fWidth=d;this._fHeight=e;this._sequences={};this._sequence=null;this._maxFrames=Math.floor(b/d*c/e);this._gl=a;this._changed=!0}function A(a){this._gl=a}function h(){}function l(){}function q(){}function n(){}var E={version:"0.903"};r.prototype.createModel=function(a,b,c){var d=0,d="object"==typeof c?c[0].length:c;a=new p(this._gl,a,b,d);this._models.push(a);if("object"==typeof c)for(var e in c)a.setAttribute(c[e],e);return a};r.prototype.model=r.prototype.createModel;
r.prototype.createSpritelyModel=function(a,b,c,d,e,f,g){var k=this._gl,h=1,l=1;d>e?l=e/d:e>d&&(h=d/e);h=[h,l,0,-h,l,0,h,-l,0,-h,-l,0];a=this.createModel(a,k.TRIANGLE_STRIP,4);a.addAttribute(h,g);a.addAttribute([1,1,0,1,1,0,0,0],f,2);var n=new t(this._gl,b,c,d,e);a.addModifier(f,n);a.setSequence=z(n,"setSequence");a.useSequence=z(n,"useSequence");a.nextFrame=function(){n.nextFrame()};return a};r.prototype.sprite=r.prototype.createSpritelyModel;r.prototype.loadModel=function(a,b,c,d){var e=this._gl;
u.ajax(b,{dataType:"json",error:function(a,c){alert('Loading model from "'+b+'" failed: '+c)},success:function(b){if(b.objs)for(var g=0;g<b.objs.length;++g){var k=b.objs[g];k.mesh&&(k=C(e,a,k.mesh,c),d(k))}else b.v&&(k=C(e,a,b,c),d(k))}})};r.prototype.loadMaterial=function(a,b,c){var d=new m(this._gl),e=!1,f=!1;u.ajax(a,{dataType:"text",error:function(){alert("Loading sahder from "+a+"failed")},success:function(a){d.vs(a);f&&(d.link(),c(d));e=!0}});u.ajax(b,{dataType:"text",error:function(){alert("Loading sahder from "+
b+"failed")},success:function(a){d.fs(a);e&&(d.link(),c(d));f=!0}});return d};var C=function(a,b,c,d){a=a.x.createModel(b,a.TRIANGLES,c.f.length);d.verts?a.addAttribute(c.v,d.verts):alert("Missing required attribute verts in loadModel param.");d.norms&&(c.n?a.addAttribute(c.n,d.norms):alert("Model missing norms param, but required by attrs."));a.addElementArray(c.f);return a};r.prototype.createMaterial=function(a,b,c){var d=this.currentMaterial=new m(this._gl);d.vs(a);d.fs(b);d.link();c&&(c.p&&d.p(c.p),
c.m&&d.m(c.m),c.n&&d.n(c.n));return d};r.prototype.material=r.prototype.createMaterial;r.prototype.initDepth=function(a){a||(a=1);var b=this._gl;b.clearColor(0,0,0,1);b.clearDepth(a);b.enable(b.DEPTH_TEST);b.depthFunc(b.LEQUAL)};r.prototype.clear=function(a){var b=this._gl;a||(a=b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);b.clear(a)};r.prototype.models=function(a){return"number"==typeof a?this._models[a]:new x(p,this._models)};x.prototype.addFunction=function(a){this[a]=function(){for(var b=0;b<this._items.length;++b){var c=
this._items[b];c[a].apply(c,arguments)}return this}};x.prototype.each=function(a){for(var b=0;b<this._items.length;++b)a(this._items[b],b);return this};m.prototype.p=function(a){return this.addUniform(this.DefaultMatrix.P,a)};m.prototype.m=function(a){return this.addUniform(this.DefaultMatrix.M,a)};m.prototype.c=function(a){return this.addUniform(this.DefaultMatrix.C,a)};m.prototype.n=function(a){return this.addUniform(this.DefaultMatrix.N,a)};m.prototype.link=function(){var a=this._gl,b=this.prog;
a.linkProgram(b);a.getProgramParameter(b,a.LINK_STATUS)||alert("Shader program link failed: "+a.getProgramInfoLog(b));return this};m.prototype._srcFromElement=function(a){var b=a.val();""===b&&(b=a.text());a=a.attr("id");return!b||""===b?(alert("No source for shader with id: "+a),null):b};m.prototype._extractSrc=function(a){if(0<=a.indexOf("{"))return a;var b=u("#"+a);(!b||b.length&&0===b.length)&&alert("Unable to find shader element with id "+a);return this._srcFromElement(b)};m.prototype.vs=function(a){a=
this._extractSrc(a);return this._loadShaderSource(a,this._gl.VERTEX_SHADER)};m.prototype.fs=function(a){a=this._extractSrc(a);return this._loadShaderSource(a,this._gl.FRAGMENT_SHADER)};m.prototype._loadShaderSource=function(a,b){var c=this._gl,d=c.createShader(b);c.shaderSource(d,a);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))return alert("Shader compilation failed: \n"+a+"\n\n"+c.getShaderInfoLog(d)),null;d&&(this._shaders[b]&&c.detachShader(this.prog,this._shaders[b]),c.attachShader(this.prog,
d),this._shaders[b]=d,c.deleteShader(d));return this};m.prototype.addUniform=function(a,b){this._uniforms[b]=a;return this};m.prototype.uniform=m.prototype.addUniform;m.prototype.addTexture=function(a,b,c){b||alert("No uniform name supplied for texture: "+a);var d=this._gl,e=d.createTexture(),f=new Image,g=this;f.onload=function(){d.bindTexture(d.TEXTURE_2D,e);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,f);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,
d.TEXTURE_MIN_FILTER,d.LINEAR_MIPMAP_NEAREST);d.generateMipmap(d.TEXTURE_2D);d.bindTexture(d.TEXTURE_2D,null);g._textures[b]=e;c&&c()};f.src=a;return this};m.prototype.texture=m.prototype.addTexture;m.prototype.setTextures=function(){var a=this._gl,b=0,c;for(c in this._textures)a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this._textures[c]),a.uniform1i(a.getUniformLocation(this.prog,c),b),b++};m.prototype.setUniforms=function(){var a=this._gl,b;for(b in this._uniforms){var c=this._uniforms[b];
c==this.DefaultMatrix.M?c=a.m.m:c==this.DefaultMatrix.P?c=a.m.p:c==this.DefaultMatrix.C?c=a.m.c:c==this.DefaultMatrix.N&&(c=a.m.m.inverse().transpose());var d=a.getUniformLocation(this.prog,b);d||alert("Unable to find uniform name "+b+" in shaders.");for(var e=[],f=0;4>f;++f)for(var g=0;4>g;++g)e.push(c.elements[g][f]);a.uniformMatrix4fv(d,!1,new Float32Array(e))}};s.prototype.lookAt=function(a,b,c){a=w(a);c=w(c).toUnitVector();b=w(w(b).subtract(a)).toUnitVector();c=b.cross(c);var d=c.cross(b);b=
y([[c.elements[0],c.elements[1],c.elements[2],0],[d.elements[0],d.elements[1],d.elements[2],0],[-b.elements[0],-b.elements[1],-b.elements[2],0],[0,0,0,1]]);a=D(a.x(-1));this.c=b.x(a);return this};s.prototype.perspective=function(a,b,c,d,e){c=1*c/d;d=2*a*Math.tan(e*Math.PI/360);this.p=y([[2*a/(c*d),0,0,0],[0,2*a/d,0,0],[0,0,-(b+a)/(b-a),-2*b*a/(b-a)],[0,0,-1,0]]);return this};s.prototype.push=function(){this._stack.push(this.m.dup());return this};s.prototype.pop=function(){this.m=this._stack.pop();
return this};s.prototype.apply=function(a){this.m=a.x(this.m);return this};s.prototype.identity=function(){this.m=l.I(4);return this};s.prototype.i=function(){return this.identity()};var D=function(a){var b=l.I(4);a.elements&&(a=a.elements);for(var c=0;c<a.length;++c)b.elements[c][3]=a[c];return b};s.prototype.translate=function(a){a=D(a);this.apply(a);return this};s.prototype.rotate=function(a,b){a=a*Math.PI/180;b=w(b).toUnitVector();var c=b.elements[0],d=b.elements[1],e=b.elements[2],f=Math.cos(a),
g=Math.sin(a),k=1-f,c=y([[k*c*c+f,k*c*d-g*e,k*c*e+g*d,0],[k*c*d+g*e,k*d*d+f,k*d*e-g*c,0],[k*c*e-g*d,k*d*e+g*c,k*e*e+f,0],[0,0,0,1]]);this.apply(c);return this};p.prototype.update=function(){};p.prototype.draw=function(){};p.prototype._setAttributes=function(){for(var a=this._gl,b=0;b<this._buffers.length;++b){var c=this._buffers[b].name,d=this._buffers[b].attr,e=this._buffers[b].buffer,f=this._buffers[b].l;a.bindBuffer(a.ARRAY_BUFFER,e);if(c=this._modifiers[c])for(var g=0;g<c.length;g++)c[g].modifyAttributeBuffer(e);
a.vertexAttribPointer(d,f,a.FLOAT,!1,0,0);a.enableVertexAttribArray(d)}this._elementArray&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this._elementArray)};p.prototype.addAttribute=function(a,b,c){var d=this._gl;c||(c=3);var e=d.getAttribLocation(this._material.prog,b);-1==e&&alert("Unable to find attribute name "+b+" in shaders.");var f=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,f);d.bufferData(d.ARRAY_BUFFER,new Float32Array(a),d.STATIC_DRAW);this._buffers.push({name:b,attr:e,buffer:f,l:c});return this};
p.prototype.attr=p.prototype.addAttribute;p.prototype.addElementArray=function(a){var b=this._gl,c=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,c);b.bufferData(b.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),b.STATIC_DRAW);this._elementArray=c;return this};p.prototype.elem=p.prototype.addElementArray;p.prototype.useOrientation=function(){this.o=this.orientation=new s;this.o.perspective=void 0};p.prototype._draw=function(){if(!this._enabled)return this;var a=this._gl;this.o&&a.m.push().apply(this.o.m);
a.useProgram(this._material.prog);this._setAttributes();this._material.setTextures();this._material.setUniforms();this.o&&a.m.pop();this._elementArray?a.drawElements(this._type,this._vert_length,a.UNSIGNED_SHORT,0):a.drawArrays(this._type,0,this._vert_length);return this};p.prototype.show=function(){this._enabled=!0;return this};p.prototype.hide=function(){this._enabled=!1;return this};p.prototype.toggle=function(){this._enabled=!this._enabled;return this};p.prototype.addModifier=function(a,b){this._modifiers[a]?
this._modifiers[a].push(b):this._modifiers[a]=[b]};t.prototype.nextFrame=function(){if(this._sequence){var a=this._sequence;this._frame<a.end?(this._frame++,this._frame<a.start&&(this._frame=a.start)):a.loop&&(this._frame=a.start)}else this._frame=(this._frame+1)%this._maxFrames;this._changed=!0;return this};t.prototype.useSequence=function(a){this._sequence=this._sequences[a];this._frame=this._sequence.start;return this};t.prototype.setSequence=function(a,b,c,d){this._sequences[a]={start:b,end:c,
loop:d};return this};t.prototype._uvForFrame=function(){var a=Math.floor(this._width/this._fWidth),b=Math.floor(this._frame/a),c=this._frame%a,a=c*this._fWidth/this._width,c=(c+1)*this._fWidth/this._width,d=b*this._fHeight/this._height,b=(b+1)*this._fHeight/this._height;return[c,d,a,d,c,b,a,b]};t.prototype.modifyAttributeBuffer=function(){if(this._changed){var a=this._gl,b=this._uvForFrame();a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);this._changed=!1}};A.prototype.imageShader=
function(a){var b=this._gl;b.x.initDepth(1);a=b.x.createMaterial("attribute vec3 aPos;\nattribute vec2 aTex;\nvarying highp vec2 vTex;\nvoid main(void) {\n  gl_Position = vec4(aPos, 1.0);\n  vTex = aTex;\n}\n",a);var c=b.x.createModel(a,b.TRIANGLE_STRIP,4);c.addAttribute([1,-1,0,-1,-1,0,1,1,0,-1,1,0],"aPos");c.addAttribute([1,1,0,1,1,0,0,0],"aTex",2);b.x.draw(function(a){a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);a.x.models().draw()});return a};h.prototype={e:function(a){return 1>a||a>this.elements.length?
null:this.elements[a-1]},dimensions:function(){return this.elements.length},modulus:function(){return Math.sqrt(this.dot(this))},eql:function(a){var b=this.elements.length;a=a.elements||a;if(b!=a.length)return!1;do if(1E-6<Math.abs(this.elements[b-1]-a[b-1]))return!1;while(--b);return!0},dup:function(){return h.create(this.elements)},map:function(a){var b=[];this.each(function(c,d){b.push(a(c,d))});return h.create(b)},each:function(a){var b=this.elements.length,c=b,d;do d=c-b,a(this.elements[d],d+
1);while(--b)},toUnitVector:function(){var a=this.modulus();return 0===a?this.dup():this.map(function(b){return b/a})},angleFrom:function(a){var b=a.elements||a;if(this.elements.length!=b.length)return null;var c=0,d=0,e=0;this.each(function(a,g){c+=a*b[g-1];d+=a*a;e+=b[g-1]*b[g-1]});d=Math.sqrt(d);e=Math.sqrt(e);if(0===d*e)return null;a=c/(d*e);-1>a&&(a=-1);1<a&&(a=1);return Math.acos(a)},isParallelTo:function(a){a=this.angleFrom(a);return null===a?null:1E-6>=a},isAntiparallelTo:function(a){a=this.angleFrom(a);
return null===a?null:1E-6>=Math.abs(a-Math.PI)},isPerpendicularTo:function(a){a=this.dot(a);return null===a?null:1E-6>=Math.abs(a)},add:function(a){var b=a.elements||a;return this.elements.length!=b.length?null:this.map(function(a,d){return a+b[d-1]})},subtract:function(a){var b=a.elements||a;return this.elements.length!=b.length?null:this.map(function(a,d){return a-b[d-1]})},multiply:function(a){return this.map(function(b){return b*a})},x:function(a){return this.multiply(a)},dot:function(a){a=a.elements||
a;var b=0,c=this.elements.length;if(c!=a.length)return null;do b+=this.elements[c-1]*a[c-1];while(--c);return b},cross:function(a){a=a.elements||a;if(3!=this.elements.length||3!=a.length)return null;var b=this.elements;return h.create([b[1]*a[2]-b[2]*a[1],b[2]*a[0]-b[0]*a[2],b[0]*a[1]-b[1]*a[0]])},max:function(){var a=0,b=this.elements.length,c=b,d;do d=c-b,Math.abs(this.elements[d])>Math.abs(a)&&(a=this.elements[d]);while(--b);return a},indexOf:function(a){var b=null,c=this.elements.length,d=c,e;
do e=d-c,null===b&&this.elements[e]==a&&(b=e+1);while(--c);return b},toDiagonalMatrix:function(){return l.Diagonal(this.elements)},round:function(){return this.map(function(a){return Math.round(a)})},snapTo:function(a){return this.map(function(b){return 1E-6>=Math.abs(b-a)?a:b})},distanceFrom:function(a){if(a.anchor)return a.distanceFrom(this);var b=a.elements||a;if(b.length!=this.elements.length)return null;var c=0,d;this.each(function(a,f){d=a-b[f-1];c+=d*d});return Math.sqrt(c)},liesOn:function(a){return a.contains(this)},
liesIn:function(a){return a.contains(this)},rotate:function(a,b){var c,d,e,f;switch(this.elements.length){case 2:c=b.elements||b;if(2!=c.length)return null;d=l.Rotation(a).elements;e=this.elements[0]-c[0];f=this.elements[1]-c[1];return h.create([c[0]+d[0][0]*e+d[0][1]*f,c[1]+d[1][0]*e+d[1][1]*f]);case 3:if(!b.direction)return null;var g=b.pointClosestTo(this).elements;d=l.Rotation(a,b.direction).elements;e=this.elements[0]-g[0];f=this.elements[1]-g[1];c=this.elements[2]-g[2];return h.create([g[0]+
d[0][0]*e+d[0][1]*f+d[0][2]*c,g[1]+d[1][0]*e+d[1][1]*f+d[1][2]*c,g[2]+d[2][0]*e+d[2][1]*f+d[2][2]*c]);default:return null}},reflectionIn:function(a){if(a.anchor){var b=this.elements.slice();a=a.pointClosestTo(b).elements;return h.create([a[0]+(a[0]-b[0]),a[1]+(a[1]-b[1]),a[2]+(a[2]-(b[2]||0))])}var c=a.elements||a;return this.elements.length!=c.length?null:this.map(function(a,b){return c[b-1]+(c[b-1]-a)})},to3D:function(){var a=this.dup();switch(a.elements.length){case 3:break;case 2:a.elements.push(0);
break;default:return null}return a},inspect:function(){return"["+this.elements.join(", ")+"]"},setElements:function(a){this.elements=(a.elements||a).slice();return this}};h.create=function(a){return(new h).setElements(a)};h.i=h.create([1,0,0]);h.j=h.create([0,1,0]);h.k=h.create([0,0,1]);h.Random=function(a){var b=[];do b.push(Math.random());while(--a);return h.create(b)};h.Zero=function(a){var b=[];do b.push(0);while(--a);return h.create(b)};l.prototype={e:function(a,b){return 1>a||a>this.elements.length||
1>b||b>this.elements[0].length?null:this.elements[a-1][b-1]},row:function(a){return a>this.elements.length?null:h.create(this.elements[a-1])},col:function(a){if(a>this.elements[0].length)return null;var b=[],c=this.elements.length,d=c,e;do e=d-c,b.push(this.elements[e][a-1]);while(--c);return h.create(b)},dimensions:function(){return{rows:this.elements.length,cols:this.elements[0].length}},rows:function(){return this.elements.length},cols:function(){return this.elements[0].length},eql:function(a){a=
a.elements||a;"undefined"==typeof a[0][0]&&(a=l.create(a).elements);if(this.elements.length!=a.length||this.elements[0].length!=a[0].length)return!1;var b=this.elements.length,c=b,d,e,f=this.elements[0].length,g;do{d=c-b;e=f;do if(g=f-e,1E-6<Math.abs(this.elements[d][g]-a[d][g]))return!1;while(--e)}while(--b);return!0},dup:function(){return l.create(this.elements)},map:function(a){var b=[],c=this.elements.length,d=c,e,f,g=this.elements[0].length,k;do{e=d-c;f=g;b[e]=[];do k=g-f,b[e][k]=a(this.elements[e][k],
e+1,k+1);while(--f)}while(--c);return l.create(b)},isSameSizeAs:function(a){a=a.elements||a;"undefined"==typeof a[0][0]&&(a=l.create(a).elements);return this.elements.length==a.length&&this.elements[0].length==a[0].length},add:function(a){var b=a.elements||a;"undefined"==typeof b[0][0]&&(b=l.create(b).elements);return!this.isSameSizeAs(b)?null:this.map(function(a,d,e){return a+b[d-1][e-1]})},subtract:function(a){var b=a.elements||a;"undefined"==typeof b[0][0]&&(b=l.create(b).elements);return!this.isSameSizeAs(b)?
null:this.map(function(a,d,e){return a-b[d-1][e-1]})},canMultiplyFromLeft:function(a){a=a.elements||a;"undefined"==typeof a[0][0]&&(a=l.create(a).elements);return this.elements[0].length==a.length},multiply:function(a){if(!a.elements)return this.map(function(b){return b*a});var b=a.modulus?!0:!1,c=a.elements||a;"undefined"==typeof c[0][0]&&(c=l.create(c).elements);if(!this.canMultiplyFromLeft(c))return null;var d=this.elements.length,e=d,f,g,k=c[0].length,h,B=this.elements[0].length,n=[],m,p,q;do{f=
e-d;n[f]=[];g=k;do{h=k-g;m=0;p=B;do q=B-p,m+=this.elements[f][q]*c[q][h];while(--p);n[f][h]=m}while(--g)}while(--d);c=l.create(n);return b?c.col(1):c},x:function(a){return this.multiply(a)},minor:function(a,b,c,d){var e=[],f=c,g,k,h,n=this.elements.length,m=this.elements[0].length;do{g=c-f;e[g]=[];k=d;do h=d-k,e[g][h]=this.elements[(a+g-1)%n][(b+h-1)%m];while(--k)}while(--f);return l.create(e)},transpose:function(){var a=this.elements.length,b=this.elements[0].length,c=[],d=b,e,f,g;do{e=b-d;c[e]=
[];f=a;do g=a-f,c[e][g]=this.elements[g][e];while(--f)}while(--d);return l.create(c)},isSquare:function(){return this.elements.length==this.elements[0].length},max:function(){var a=0,b=this.elements.length,c=b,d,e,f=this.elements[0].length,g;do{d=c-b;e=f;do g=f-e,Math.abs(this.elements[d][g])>Math.abs(a)&&(a=this.elements[d][g]);while(--e)}while(--b);return a},indexOf:function(a){var b=this.elements.length,c=b,d,e,f=this.elements[0].length,g;do{d=c-b;e=f;do if(g=f-e,this.elements[d][g]==a)return{i:d+
1,j:g+1};while(--e)}while(--b);return null},diagonal:function(){if(!this.isSquare)return null;var a=[],b=this.elements.length,c=b,d;do d=c-b,a.push(this.elements[d][d]);while(--b);return h.create(a)},toRightTriangular:function(){var a=this.dup(),b,c=this.elements.length,d=c,e,f,g=this.elements[0].length,k;do{e=d-c;if(0==a.elements[e][e])for(j=e+1;j<d;j++)if(0!=a.elements[j][e]){b=[];f=g;do k=g-f,b.push(a.elements[e][k]+a.elements[j][k]);while(--f);a.elements[e]=b;break}if(0!=a.elements[e][e])for(j=
e+1;j<d;j++){var h=a.elements[j][e]/a.elements[e][e];b=[];f=g;do k=g-f,b.push(k<=e?0:a.elements[j][k]-a.elements[e][k]*h);while(--f);a.elements[j]=b}}while(--c);return a},toUpperTriangular:function(){return this.toRightTriangular()},determinant:function(){if(!this.isSquare())return null;var a=this.toRightTriangular(),b=a.elements[0][0],c=a.elements.length-1,d=c,e;do e=d-c+1,b*=a.elements[e][e];while(--c);return b},det:function(){return this.determinant()},isSingular:function(){return this.isSquare()&&
0===this.determinant()},trace:function(){if(!this.isSquare())return null;var a=this.elements[0][0],b=this.elements.length-1,c=b,d;do d=c-b+1,a+=this.elements[d][d];while(--b);return a},tr:function(){return this.trace()},rank:function(){var a=this.toRightTriangular(),b=0,c=this.elements.length,d=c,e,f,g=this.elements[0].length,k;do{e=d-c;f=g;do if(k=g-f,1E-6<Math.abs(a.elements[e][k])){b++;break}while(--f)}while(--c);return b},rk:function(){return this.rank()},augment:function(a){a=a.elements||a;"undefined"==
typeof a[0][0]&&(a=l.create(a).elements);var b=this.dup(),c=b.elements[0].length,d=b.elements.length,e=d,f,g,k=a[0].length,h;if(d!=a.length)return null;do{f=e-d;g=k;do h=k-g,b.elements[f][c+h]=a[f][h];while(--g)}while(--d);return b},inverse:function(){if(!this.isSquare()||this.isSingular())return null;var a=this.elements.length,b=a,c,d,e=this.augment(l.I(a)).toRightTriangular(),f,g=e.elements[0].length,k,h,n=[],m;do{c=a-1;h=[];f=g;n[c]=[];d=e.elements[c][c];do k=g-f,m=e.elements[c][k]/d,h.push(m),
k>=b&&n[c].push(m);while(--f);e.elements[c]=h;for(d=0;d<c;d++){h=[];f=g;do k=g-f,h.push(e.elements[d][k]-e.elements[c][k]*e.elements[d][c]);while(--f);e.elements[d]=h}}while(--a);return l.create(n)},inv:function(){return this.inverse()},round:function(){return this.map(function(a){return Math.round(a)})},snapTo:function(a){return this.map(function(b){return 1E-6>=Math.abs(b-a)?a:b})},inspect:function(){var a=[],b=this.elements.length,c=b,d;do d=c-b,a.push(h.create(this.elements[d]).inspect());while(--b);
return a.join("\n")},setElements:function(a){var b=a.elements||a;if("undefined"!=typeof b[0][0]){var c=b.length,d=c,e,f,g;this.elements=[];do{a=d-c;f=e=b[a].length;this.elements[a]=[];do g=f-e,this.elements[a][g]=b[a][g];while(--e)}while(--c);return this}d=c=b.length;this.elements=[];do a=d-c,this.elements.push([b[a]]);while(--c);return this}};l.create=function(a){return(new l).setElements(a)};l.I=function(a){var b=[],c=a,d,e,f;do{d=c-a;b[d]=[];e=c;do f=c-e,b[d][f]=d==f?1:0;while(--e)}while(--a);
return l.create(b)};l.Diagonal=function(a){var b=a.length,c=b,d,e=l.I(b);do d=c-b,e.elements[d][d]=a[d];while(--b);return e};l.Rotation=function(a,b){if(!b)return l.create([[Math.cos(a),-Math.sin(a)],[Math.sin(a),Math.cos(a)]]);var c=b.dup();if(3!=c.elements.length)return null;var d=c.modulus(),e=c.elements[0]/d,f=c.elements[1]/d,c=c.elements[2]/d,d=Math.sin(a),g=Math.cos(a),k=1-g;return l.create([[k*e*e+g,k*e*f-d*c,k*e*c+d*f],[k*e*f+d*c,k*f*f+g,k*f*c-d*e],[k*e*c-d*f,k*f*c+d*e,k*c*c+g]])};l.RotationX=
function(a){var b=Math.cos(a);a=Math.sin(a);return l.create([[1,0,0],[0,b,-a],[0,a,b]])};l.RotationY=function(a){var b=Math.cos(a);a=Math.sin(a);return l.create([[b,0,a],[0,1,0],[-a,0,b]])};l.RotationZ=function(a){var b=Math.cos(a);a=Math.sin(a);return l.create([[b,-a,0],[a,b,0],[0,0,1]])};l.Random=function(a,b){return l.Zero(a,b).map(function(){return Math.random()})};l.Zero=function(a,b){var c=[],d=a,e,f,g;do{e=a-d;c[e]=[];f=b;do g=b-f,c[e][g]=0;while(--f)}while(--d);return l.create(c)};q.prototype=
{eql:function(a){return this.isParallelTo(a)&&this.contains(a.anchor)},dup:function(){return q.create(this.anchor,this.direction)},translate:function(a){a=a.elements||a;return q.create([this.anchor.elements[0]+a[0],this.anchor.elements[1]+a[1],this.anchor.elements[2]+(a[2]||0)],this.direction)},isParallelTo:function(a){if(a.normal)return a.isParallelTo(this);a=this.direction.angleFrom(a.direction);return 1E-6>=Math.abs(a)||1E-6>=Math.abs(a-Math.PI)},distanceFrom:function(a){if(a.normal)return a.distanceFrom(this);
if(a.direction){if(this.isParallelTo(a))return this.distanceFrom(a.anchor);var b=this.direction.cross(a.direction).toUnitVector().elements,c=this.anchor.elements;a=a.anchor.elements;return Math.abs((c[0]-a[0])*b[0]+(c[1]-a[1])*b[1]+(c[2]-a[2])*b[2])}var d=a.elements||a,c=this.anchor.elements,b=this.direction.elements;a=d[0]-c[0];var e=d[1]-c[1],d=(d[2]||0)-c[2],c=Math.sqrt(a*a+e*e+d*d);if(0===c)return 0;b=(a*b[0]+e*b[1]+d*b[2])/c;b=1-b*b;return Math.abs(c*Math.sqrt(0>b?0:b))},contains:function(a){a=
this.distanceFrom(a);return null!==a&&1E-6>=a},liesIn:function(a){return a.contains(this)},intersects:function(a){return a.normal?a.intersects(this):!this.isParallelTo(a)&&1E-6>=this.distanceFrom(a)},intersectionWith:function(a){if(a.normal)return a.intersectionWith(this);if(!this.intersects(a))return null;var b=this.anchor.elements,c=this.direction.elements,d=a.anchor.elements,e=a.direction.elements;a=c[0];var f=c[1],c=c[2],g=e[0],k=e[1],e=e[2],l=b[0]-d[0],n=b[1]-d[1],d=b[2]-d[2],m=g*g+k*k+e*e,p=
a*g+f*k+c*e,g=((-a*l-f*n-c*d)*m/(a*a+f*f+c*c)+p*(g*l+k*n+e*d))/(m-p*p);return h.create([b[0]+g*a,b[1]+g*f,b[2]+g*c])},pointClosestTo:function(a){if(a.direction){if(this.intersects(a))return this.intersectionWith(a);if(this.isParallelTo(a))return null;var b=this.direction.elements,c=a.direction.elements,d=b[0],e=b[1],b=b[2],f=c[0],g=c[1],k=c[2],c=b*f-d*k,l=d*g-e*f,m=e*k-b*g,d=h.create([c*k-l*g,l*f-m*k,m*g-c*f]);a=n.create(a.anchor,d);return a.intersectionWith(this)}a=a.elements||a;if(this.contains(a))return h.create(a);
c=this.anchor.elements;b=this.direction.elements;d=b[0];e=b[1];b=b[2];f=c[0];l=c[1];g=c[2];c=d*(a[1]-l)-e*(a[0]-f);l=e*((a[2]||0)-g)-b*(a[1]-l);m=b*(a[0]-f)-d*((a[2]||0)-g);d=h.create([e*c-b*m,b*l-d*c,d*m-e*l]);e=this.distanceFrom(a)/d.modulus();return h.create([a[0]+d.elements[0]*e,a[1]+d.elements[1]*e,(a[2]||0)+d.elements[2]*e])},rotate:function(a,b){"undefined"==typeof b.direction&&(b=q.create(b.to3D(),h.k));var c=l.Rotation(a,b.direction).elements,d=b.pointClosestTo(this.anchor).elements,e=this.anchor.elements,
f=this.direction.elements,g=d[0],k=d[1],d=d[2],m=e[0]-g,n=e[1]-k,e=e[2]-d;return q.create([g+c[0][0]*m+c[0][1]*n+c[0][2]*e,k+c[1][0]*m+c[1][1]*n+c[1][2]*e,d+c[2][0]*m+c[2][1]*n+c[2][2]*e],[c[0][0]*f[0]+c[0][1]*f[1]+c[0][2]*f[2],c[1][0]*f[0]+c[1][1]*f[1]+c[1][2]*f[2],c[2][0]*f[0]+c[2][1]*f[1]+c[2][2]*f[2]])},reflectionIn:function(a){if(a.normal){var b=this.anchor.elements,c=this.direction.elements,d=b[0],e=b[1],b=b[2],f=c[0],g=c[1],k=c[2],c=this.anchor.reflectionIn(a).elements,d=d+f,e=e+g,b=b+k;a=
a.pointClosestTo([d,e,b]).elements;return q.create(c,[a[0]+(a[0]-d)-c[0],a[1]+(a[1]-e)-c[1],a[2]+(a[2]-b)-c[2]])}if(a.direction)return this.rotate(Math.PI,a);a=a.elements||a;return q.create(this.anchor.reflectionIn([a[0],a[1],a[2]||0]),this.direction)},setVectors:function(a,b){a=h.create(a);b=h.create(b);2==a.elements.length&&a.elements.push(0);2==b.elements.length&&b.elements.push(0);if(3<a.elements.length||3<b.elements.length)return null;var c=b.modulus();if(0===c)return null;this.anchor=a;this.direction=
h.create([b.elements[0]/c,b.elements[1]/c,b.elements[2]/c]);return this}};q.create=function(a,b){return(new q).setVectors(a,b)};q.X=q.create(h.Zero(3),h.i);q.Y=q.create(h.Zero(3),h.j);q.Z=q.create(h.Zero(3),h.k);n.prototype={eql:function(a){return this.contains(a.anchor)&&this.isParallelTo(a)},dup:function(){return n.create(this.anchor,this.normal)},translate:function(a){a=a.elements||a;return n.create([this.anchor.elements[0]+a[0],this.anchor.elements[1]+a[1],this.anchor.elements[2]+(a[2]||0)],this.normal)},
isParallelTo:function(a){return a.normal?(a=this.normal.angleFrom(a.normal),1E-6>=Math.abs(a)||1E-6>=Math.abs(Math.PI-a)):a.direction?this.normal.isPerpendicularTo(a.direction):null},isPerpendicularTo:function(a){a=this.normal.angleFrom(a.normal);return 1E-6>=Math.abs(Math.PI/2-a)},distanceFrom:function(a){if(this.intersects(a)||this.contains(a))return 0;if(a.anchor){var b=this.anchor.elements,c=a.anchor.elements;a=this.normal.elements;return Math.abs((b[0]-c[0])*a[0]+(b[1]-c[1])*a[1]+(b[2]-c[2])*
a[2])}c=a.elements||a;b=this.anchor.elements;a=this.normal.elements;return Math.abs((b[0]-c[0])*a[0]+(b[1]-c[1])*a[1]+(b[2]-(c[2]||0))*a[2])},contains:function(a){if(a.normal)return null;if(a.direction)return this.contains(a.anchor)&&this.contains(a.anchor.add(a.direction));a=a.elements||a;var b=this.anchor.elements,c=this.normal.elements;return 1E-6>=Math.abs(c[0]*(b[0]-a[0])+c[1]*(b[1]-a[1])+c[2]*(b[2]-(a[2]||0)))},intersects:function(a){return"undefined"==typeof a.direction&&"undefined"==typeof a.normal?
null:!this.isParallelTo(a)},intersectionWith:function(a){if(!this.intersects(a))return null;if(a.direction){var b=a.anchor.elements,c=a.direction.elements;a=this.anchor.elements;var d=this.normal.elements;a=(d[0]*(a[0]-b[0])+d[1]*(a[1]-b[1])+d[2]*(a[2]-b[2]))/(d[0]*c[0]+d[1]*c[1]+d[2]*c[2]);return h.create([b[0]+c[0]*a,b[1]+c[1]*a,b[2]+c[2]*a])}if(a.normal){var c=this.normal.cross(a.normal).toUnitVector(),d=this.normal.elements,b=this.anchor.elements,e=a.normal.elements,f=a.anchor.elements,g=l.Zero(2,
2);for(a=0;g.isSingular();)a++,g=l.create([[d[a%3],d[(a+1)%3]],[e[a%3],e[(a+1)%3]]]);g=g.inverse().elements;b=d[0]*b[0]+d[1]*b[1]+d[2]*b[2];d=e[0]*f[0]+e[1]*f[1]+e[2]*f[2];b=[g[0][0]*b+g[0][1]*d,g[1][0]*b+g[1][1]*d];d=[];for(e=1;3>=e;e++)d.push(a==e?0:b[(e+(5-a)%3)%3]);return q.create(d,c)}},pointClosestTo:function(a){a=a.elements||a;var b=this.anchor.elements,c=this.normal.elements,b=(b[0]-a[0])*c[0]+(b[1]-a[1])*c[1]+(b[2]-(a[2]||0))*c[2];return h.create([a[0]+c[0]*b,a[1]+c[1]*b,(a[2]||0)+c[2]*b])},
rotate:function(a,b){var c=l.Rotation(a,b.direction).elements,d=b.pointClosestTo(this.anchor).elements,e=this.anchor.elements,f=this.normal.elements,g=d[0],k=d[1],d=d[2],h=e[0]-g,m=e[1]-k,e=e[2]-d;return n.create([g+c[0][0]*h+c[0][1]*m+c[0][2]*e,k+c[1][0]*h+c[1][1]*m+c[1][2]*e,d+c[2][0]*h+c[2][1]*m+c[2][2]*e],[c[0][0]*f[0]+c[0][1]*f[1]+c[0][2]*f[2],c[1][0]*f[0]+c[1][1]*f[1]+c[1][2]*f[2],c[2][0]*f[0]+c[2][1]*f[1]+c[2][2]*f[2]])},reflectionIn:function(a){if(a.normal){var b=this.anchor.elements,c=this.normal.elements,
d=b[0],e=b[1],b=b[2],f=c[0],g=c[1],h=c[2],c=this.anchor.reflectionIn(a).elements,d=d+f,e=e+g,b=b+h;a=a.pointClosestTo([d,e,b]).elements;return n.create(c,[a[0]+(a[0]-d)-c[0],a[1]+(a[1]-e)-c[1],a[2]+(a[2]-b)-c[2]])}if(a.direction)return this.rotate(Math.PI,a);a=a.elements||a;return n.create(this.anchor.reflectionIn([a[0],a[1],a[2]||0]),this.normal)},setVectors:function(a,b,c){a=h.create(a);a=a.to3D();if(null===a)return null;b=h.create(b);b=b.to3D();if(null===b)return null;if("undefined"==typeof c)c=
null;else if(c=h.create(c),c=c.to3D(),null===c)return null;var d=a.elements[0],e=a.elements[1],f=a.elements[2],g=b.elements[0],k=b.elements[1],l=b.elements[2];if(null!==c){b=c.elements[0];var m=c.elements[1];c=c.elements[2];e=h.create([(k-e)*(c-f)-(l-f)*(m-e),(l-f)*(b-d)-(g-d)*(c-f),(g-d)*(m-e)-(k-e)*(b-d)]);d=e.modulus();if(0===d)return null;e=h.create([e.elements[0]/d,e.elements[1]/d,e.elements[2]/d])}else{d=Math.sqrt(g*g+k*k+l*l);if(0===d)return null;e=h.create([b.elements[0]/d,b.elements[1]/d,
b.elements[2]/d])}this.anchor=a;this.normal=e;return this}};n.create=function(a,b,c){return(new n).setVectors(a,b,c)};n.XY=n.create(h.Zero(3),h.k);n.YZ=n.create(h.Zero(3),h.i);n.ZX=n.create(h.Zero(3),h.j);n.YX=n.XY;n.ZY=n.YZ;n.XZ=n.ZX;var w=h.create,y=l.create;u.fn.gl=function(a){if(0==this.length)return this;var b=this[0],c=null;if(b._jquery_gl)if(c=b._jquery_gl,a)alert("Re-wrapping a wrapped gl context not supported.");else return c;else{var d=this[0],e=null;try{(e=d.getContext("webgl"))||(e=d.getContext("experimental-webgl"))}catch(f){alert("Error creating webgl context: "+
f)}e||alert("Failed to create webgl context.");c=e;b._jquery_gl=c}b=c;b.m=new s;b.x=new r(b);b.util=new A(b);a&&(a.init&&a.init(c),a.draw&&(c.x.draw(a.draw),a.draw(c)),a.update&&c.x.update(a.update),a.framerate&&0<a.framerate&&setInterval(function(){c.x.frame()},1E3/a.framerate));c.x.info=E;return c}})(jQuery);