(function(v){function x(a,b){return function(c){if(c){var d=this[a];this[a]=function(a){d.apply(this,[a]);c.apply(this,[a])}}else this[a](b);return this}}function s(a){this._models=[];this._gl=a;this._draw=function(){};this.draw=x("_draw",this._gl);this._update=function(){};this.update=x("_update",this._gl);this._frame=function(){this._draw(this._gl);this._update(this._gl)};this.frame=x("_frame",this._gl)}function z(a,b){this._items=b;for(f in a.prototype)typeof a.prototype[f]=="function"&&this.addFunction(f)}
function o(a){a||alert("Tried to create a material with undefined context.");this._gl=a;this.prog=a.createProgram();this._shaders={};this._uniforms={};this._textures={};this.DefaultMatrix={P:0,M:1,C:2,N:3}}function t(){this._stack=[];this.m=n.I(4);this.p=n.I(4);this.c=n.I(4)}function q(a,b,c,d){a||alert("Tried to create a model with undefined context.");c||alert("Tried to create a model with undefined geometry type.");d||alert("Tried to create a model with undefined length.");this.state=null;this.o=
this.orientation=new t;this.o.perspective=void 0;this._vert_length=d;this._type=c;this._buffers=[];this._gl=a;this._material=b;this._enabled=true;if(!b)this._material=a.x.currentMaterial;this._material||alert("Must create a material before you can create a Model.");this._elementArray=null;this._modifiers={};this._update=function(){};this.update=x("_update",this._gl);this.draw=x("_draw",this._gl)}function B(a,b){return function(){a[b].apply(a,arguments);return this}}function E(a,b){a.setSequence=B(b,
"setSequence");a.useSequence=B(b,"useSequence");a.nextFrame=function(){b.nextFrame()};return a}function w(a,b,c,d,g){this._frame=0;this._width=b;this._height=c;this._fWidth=d;this._fHeight=g;this._sequences={};this._sequence=null;this._maxFrames=Math.floor(b/d*c/g);this._gl=a;this._changed=true}function C(a){this._gl=a}function l(){}function n(){}function r(){}function p(){}var F={version:"0.89"};s.prototype.createModel=function(a,b,c){model=new q(this._gl,a,b,c);this._models.push(model);return model};
s.prototype.model=s.prototype.createModel;s.prototype.createSpritelyModel=function(a,b,c,d,g,h,k){a=this.createModel(a,this._gl.TRIANGLE_STRIP,4);a.addAttribute([1,1,0,-1,1,0,1,-1,0,-1,-1,0],k);a.addAttribute([1,1,0,1,1,0,0,0],h,2);b=new w(this._gl,b,c,d,g);a.addModifier(h,b);return E(a,b)};s.prototype.sprite=s.prototype.createSpritelyModel;s.prototype.loadModel=function(a,b,c,d){v.ajax(b,{dataType:"json",error:function(a,c){alert('Loading model from "'+b+'" failed: '+c)},success:function(a){if(a.objs)for(var b=
0;b<a.objs.length;++b){var k=a.objs[b];k.mesh&&(k=modelFromMesh(gl,k.mesh,c),d(k))}else a.v&&(k=modelFromMesh(gl,a,c),d(k))}})};s.prototype.loadMaterial=function(a,b,c){var d=this._gl,g=new o(d),h=false,k=false;v.ajax(a,{dataType:"text",error:function(){},success:function(a){g.loadShaderSource(a,d.VERTEX_SHADER);k&&(g.link(),c(g));h=true}});v.ajax(b,{dataType:"text",error:function(){},success:function(a){g.loadShaderSource(a,d.FRAGMENT_SHADER);h&&(g.link(),c(g));k=true}});return g};modelFromMesh=
function(a,b,c){a=a.x.createModel(material,a.TRIANGLES,b.f.length);c.verts?a.addAttribute(b.v,c.verts):alert("Missing required attribute verts in loadModel param.");c.norms&&(b.n?a.addAttribute(b.n,c.norms):alert("Model missing norms param, but required by attrs."));a.addElementArray(b.f);return a};s.prototype.createMaterial=function(a,b){var c=this._gl;material=this.currentMaterial=new o(c);material.loadShader(a,c.VERTEX_SHADER);material.loadShader(b,c.FRAGMENT_SHADER);material.link();return material};
s.prototype.material=s.prototype.createMaterial;s.prototype.initDepth=function(a){a||(a=1);var b=this._gl;b.clearColor(0,0,0,1);b.clearDepth(a);b.enable(b.DEPTH_TEST);b.depthFunc(b.LEQUAL)};s.prototype.models=function(a){return typeof a=="number"?this._models[a]:new z(q,this._models)};z.prototype.addFunction=function(a){this[a]=function(){for(var b=0;b<this._items.length;++b){var c=this._items[b];c[a].apply(c,arguments)}return this}};z.prototype.each=function(a){for(var b=0;b<this._items.length;++b)a(this._items[b],
b);return this};o.prototype.p=function(a){return this.addUniform(this.DefaultMatrix.P,a)};o.prototype.m=function(a){return this.addUniform(this.DefaultMatrix.M,a)};o.prototype.c=function(a){return this.addUniform(this.DefaultMatrix.C,a)};o.prototype.n=function(a){return this.addUniform(this.DefaultMatrix.N,a)};o.prototype.link=function(){var a=this._gl,b=this.prog;a.linkProgram(b);a.getProgramParameter(b,a.LINK_STATUS)||alert("Shader program link failed: "+a.getProgramInfoLog(b));return this};o.prototype.loadShaderSource=
function(a,b){var c=this._gl,d=c.createShader(b);c.shaderSource(d,a);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))return alert("Shader compilation failed: \n"+a+"\n\n"+c.getShaderInfoLog(d)),null;d&&(this._shaders[b]&&c.detachShader(this.prog,this._shaders[b]),c.attachShader(this.prog,d),this._shaders[b]=d,c.deleteShader(d));return d};o.prototype._createShader=function(a,b){var c=this._gl,a=e.val();""==a&&(a=e.text());var d=e.attr("id");if(!a||a=="")return alert("No source for shader with id: "+
d),null;return!b&&(d=e.attr("type"),b=d=="x-shader/x-vertex"?compileShader(c,src,scriptId,c.VERTEX_SHADER):d=="x-shader/x-fragment"?compileShader(c,src,scriptId,c.FRAGMENT_SHADER):null,!b)?(alert('Shader script must have type attribute set to  "x-shader/x-fragment" or "x-shader/x-vertex"'),null):this.loadShaderSource(a,b)};o.prototype.loadShader=function(a,b){var c=v("#"+a);(!c||c.length&&c.length==0)&&alert("Unable to find shader element with id "+a);b||(b=getType(c));this._createShader(c,b);return this};
o.prototype.addUniform=function(a,b){this._uniforms[b]=a;return this};o.prototype.uniform=o.prototype.addUniform;o.prototype.addTexture=function(a,b,c){b||alert("No uniform name supplied for texture: "+a);gl=this._gl;texture=gl.createTexture();image=new Image;var d=this;image.onload=function(){gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,image);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,
gl.LINEAR_MIPMAP_NEAREST);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);d._textures[b]=texture;c&&c()};image.src=a;return this};o.prototype.texture=o.prototype.addTexture;o.prototype.setTextures=function(){var a=0;for(name in this._textures)gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this._textures[name]),gl.uniform1i(gl.getUniformLocation(this.prog,name),a),a++};o.prototype.setUniforms=function(){var a=this._gl;for(name in this._uniforms){var b=this._uniforms[name];
b==this.DefaultMatrix.M?b=a.m.m:b==this.DefaultMatrix.P?b=a.m.p:b==this.DefaultMatrix.C?b=a.m.c:b==this.DefaultMatrix.N&&(b=a.m.m.inverse().transpose());var c=a.getUniformLocation(this.prog,name);c||alert("Unable to find uniform name "+name+" in shaders.");for(var d=[],g=0;g<4;++g)for(var h=0;h<4;++h)d.push(b.elements[h][g]);a.uniformMatrix4fv(c,false,new Float32Array(d))}};t.prototype.lookAt=function(a,b,c){var a=y(a),c=y(c).toUnitVector(),b=y(y(b).subtract(a)).toUnitVector(),c=b.cross(c),d=c.cross(b),
b=A([[c.elements[0],c.elements[1],c.elements[2],0],[d.elements[0],d.elements[1],d.elements[2],0],[-b.elements[0],-b.elements[1],-b.elements[2],0],[0,0,0,1]]),a=D(a.x(-1));this.c=b.x(a)};t.prototype.perspective=function(a,b,c,d,g){c=c*1/d;d=2*a*Math.tan(g*Math.PI/360);return this.p=A([[2*a/(c*d),0,0,0],[0,2*a/d,0,0],[0,0,-(b+a)/(b-a),-2*b*a/(b-a)],[0,0,-1,0]])};t.prototype.push=function(){this._stack.push(this.m.dup())};t.prototype.pop=function(){this.m=this._stack.pop()};t.prototype.apply=function(a){return this.m=
a.x(this.m)};t.prototype.identity=function(){return this.m=n.I(4)};t.prototype.i=function(){return this.identity()};var D=function(a){var b=n.I(4);if(a.elements)a=a.elements;for(var c=0;c<a.length;++c)b.elements[c][3]=a[c];return b};t.prototype.translate=function(a){a=D(a);this.apply(a);return a};t.prototype.rotate=function(a,b){var a=a*Math.PI/180,b=y(b).toUnitVector(),c=b.elements[0],d=b.elements[1],g=b.elements[2],h=Math.cos(a),k=Math.sin(a),m=1-h,c=A([[m*c*c+h,m*c*d-k*g,m*c*g+k*d,0],[m*c*d+k*
g,m*d*d+h,m*d*g-k*c,0],[m*c*g-k*d,m*d*g+k*c,m*g*g+h,0],[0,0,0,1]]);this.apply(c);return c};q.prototype.update=function(){};q.prototype.draw=function(){};q.prototype._setAttributes=function(){for(i=0;i<this._buffers.length;++i){var a=this._buffers[i].name,b=this._buffers[i].attr,c=this._buffers[i].buffer,d=this._buffers[i].l,g=this._gl;g.bindBuffer(g.ARRAY_BUFFER,c);if(a=this._modifiers[a])for(var h=0;h<a.length;h++)a[h].modifyAttributeBuffer(c);g.vertexAttribPointer(b,d,g.FLOAT,false,0,0);g.enableVertexAttribArray(b)}this._elementArray&&
g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,this._elementArray)};q.prototype.addAttribute=function(a,b,c){var d=this._gl;c||(c=3);var g=d.getAttribLocation(this._material.prog,b);g==-1&&alert("Unable to find attribute name "+b+" in shaders.");var h=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,h);d.bufferData(d.ARRAY_BUFFER,new Float32Array(a),d.STATIC_DRAW);this._buffers.push({name:b,attr:g,buffer:h,l:c});return this};q.prototype.attr=q.prototype.addAttribute;q.prototype.addElementArray=function(a){var b=
this._gl;buffer=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,buffer);b.bufferData(b.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),b.STATIC_DRAW);this._elementArray=buffer;return this};q.prototype.elem=q.prototype.addElementArray;q.prototype.useOrientation=function(){this.o=this.orientation=new t;this.o.perspective=void 0};q.prototype._draw=function(){if(!this._enabled)return this;var a=this._gl;this.o&&(a.m.push(),a.m.apply(this.o.m));a.useProgram(this._material.prog);this._setAttributes();this._material.setTextures();
this._material.setUniforms();this.o&&a.m.pop();this._elementArray?a.drawElements(this._type,this._vert_length,a.UNSIGNED_SHORT,0):a.drawArrays(this._type,0,this._vert_length);return this};q.prototype.show=function(){this._enabled=true;return this};q.prototype.hide=function(){this._enabled=false;return this};q.prototype.toggle=function(){this._enabled=!this._enabled;return this};q.prototype.addModifier=function(a,b){this._modifiers[a]?this._modifiers[a].push(b):this._modifiers[a]=[b]};w.prototype.nextFrame=
function(){if(this._sequence){var a=this._sequence;if(this._frame<a.end){if(this._frame++,this._frame<a.start)this._frame=a.start}else if(a.loop)this._frame=a.start}else this._frame=(this._frame+1)%this._maxFrames;this._changed=true;return this};w.prototype.useSequence=function(a){this._sequence=this._sequences[a];return this};w.prototype.setSequence=function(a,b,c,d){this._sequences[a]={start:b,end:c,loop:d};return this};w.prototype._uvForFrame=function(){var a=Math.floor(this._frame/Math.floor(this._width/
this._fWidth)),b=this._frame%Math.floor(this._height/this._fHeight);v1=a*this._fWidth/this._width;v0=(a+1)*this._fWidth/this._width;u0=b*this._fHeight/this._height;u1=(b+1)*this._fHeight/this._height;return[u1,v1,u0,v1,u1,v0,u0,v0]};w.prototype.modifyAttributeBuffer=function(){if(this._changed){var a=this._gl,b=this._uvForFrame();a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);this._changed=false}};C.prototype.imageShader=function(a){v("body").append('<script id="__vs" type="x-shader/x-vertex">\nattribute vec3 aPos;\nattribute vec2 aTex;\nvarying highp vec2 vTex;\nvoid main(void) {\n  gl_Position = vec4(aPos, 1.0);\n  vTex = aTex;\n}\n<\/script>');
var b=this._gl;b.x.initDepth(1);var a=b.x.createMaterial("__vs",a),c=b.x.createModel(a,b.TRIANGLE_STRIP,4);c.addAttribute([1,-1,0,-1,-1,0,1,1,0,-1,1,0],"aPos");c.addAttribute([1,1,0,1,1,0,0,0],"aTex",2);b.x.draw(function(a){a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);a.x.models().draw()});return a};l.prototype={e:function(a){return a<1||a>this.elements.length?null:this.elements[a-1]},dimensions:function(){return this.elements.length},modulus:function(){return Math.sqrt(this.dot(this))},eql:function(a){var b=
this.elements.length,a=a.elements||a;if(b!=a.length)return false;do if(Math.abs(this.elements[b-1]-a[b-1])>1.0E-6)return false;while(--b);return true},dup:function(){return l.create(this.elements)},map:function(a){var b=[];this.each(function(c,d){b.push(a(c,d))});return l.create(b)},each:function(a){var b=this.elements.length,c=b,d;do d=c-b,a(this.elements[d],d+1);while(--b)},toUnitVector:function(){var a=this.modulus();return a===0?this.dup():this.map(function(b){return b/a})},angleFrom:function(a){var b=
a.elements||a;if(this.elements.length!=b.length)return null;var c=0,d=0,g=0;this.each(function(a,k){c+=a*b[k-1];d+=a*a;g+=b[k-1]*b[k-1]});d=Math.sqrt(d);g=Math.sqrt(g);if(d*g===0)return null;a=c/(d*g);a<-1&&(a=-1);a>1&&(a=1);return Math.acos(a)},isParallelTo:function(a){a=this.angleFrom(a);return a===null?null:a<=1.0E-6},isAntiparallelTo:function(a){a=this.angleFrom(a);return a===null?null:Math.abs(a-Math.PI)<=1.0E-6},isPerpendicularTo:function(a){a=this.dot(a);return a===null?null:Math.abs(a)<=1.0E-6},
add:function(a){var b=a.elements||a;return this.elements.length!=b.length?null:this.map(function(a,d){return a+b[d-1]})},subtract:function(a){var b=a.elements||a;return this.elements.length!=b.length?null:this.map(function(a,d){return a-b[d-1]})},multiply:function(a){return this.map(function(b){return b*a})},x:function(a){return this.multiply(a)},dot:function(a){var a=a.elements||a,b=0,c=this.elements.length;if(c!=a.length)return null;do b+=this.elements[c-1]*a[c-1];while(--c);return b},cross:function(a){a=
a.elements||a;if(this.elements.length!=3||a.length!=3)return null;var b=this.elements;return l.create([b[1]*a[2]-b[2]*a[1],b[2]*a[0]-b[0]*a[2],b[0]*a[1]-b[1]*a[0]])},max:function(){var a=0,b=this.elements.length,c=b,d;do d=c-b,Math.abs(this.elements[d])>Math.abs(a)&&(a=this.elements[d]);while(--b);return a},indexOf:function(a){var b=null,c=this.elements.length,d=c,g;do g=d-c,b===null&&this.elements[g]==a&&(b=g+1);while(--c);return b},toDiagonalMatrix:function(){return n.Diagonal(this.elements)},round:function(){return this.map(function(a){return Math.round(a)})},
snapTo:function(a){return this.map(function(b){return Math.abs(b-a)<=1.0E-6?a:b})},distanceFrom:function(a){if(a.anchor)return a.distanceFrom(this);var b=a.elements||a;if(b.length!=this.elements.length)return null;var c=0,d;this.each(function(a,h){d=a-b[h-1];c+=d*d});return Math.sqrt(c)},liesOn:function(a){return a.contains(this)},liesIn:function(a){return a.contains(this)},rotate:function(a,b){var c,d,g,h;switch(this.elements.length){case 2:c=b.elements||b;if(c.length!=2)return null;d=n.Rotation(a).elements;
g=this.elements[0]-c[0];h=this.elements[1]-c[1];return l.create([c[0]+d[0][0]*g+d[0][1]*h,c[1]+d[1][0]*g+d[1][1]*h]);case 3:if(!b.direction)return null;var k=b.pointClosestTo(this).elements;d=n.Rotation(a,b.direction).elements;g=this.elements[0]-k[0];h=this.elements[1]-k[1];c=this.elements[2]-k[2];return l.create([k[0]+d[0][0]*g+d[0][1]*h+d[0][2]*c,k[1]+d[1][0]*g+d[1][1]*h+d[1][2]*c,k[2]+d[2][0]*g+d[2][1]*h+d[2][2]*c]);default:return null}},reflectionIn:function(a){if(a.anchor){var b=this.elements.slice(),
a=a.pointClosestTo(b).elements;return l.create([a[0]+(a[0]-b[0]),a[1]+(a[1]-b[1]),a[2]+(a[2]-(b[2]||0))])}else{var c=a.elements||a;return this.elements.length!=c.length?null:this.map(function(a,b){return c[b-1]+(c[b-1]-a)})}},to3D:function(){var a=this.dup();switch(a.elements.length){case 3:break;case 2:a.elements.push(0);break;default:return null}return a},inspect:function(){return"["+this.elements.join(", ")+"]"},setElements:function(a){this.elements=(a.elements||a).slice();return this}};l.create=
function(a){return(new l).setElements(a)};l.i=l.create([1,0,0]);l.j=l.create([0,1,0]);l.k=l.create([0,0,1]);l.Random=function(a){var b=[];do b.push(Math.random());while(--a);return l.create(b)};l.Zero=function(a){var b=[];do b.push(0);while(--a);return l.create(b)};n.prototype={e:function(a,b){return a<1||a>this.elements.length||b<1||b>this.elements[0].length?null:this.elements[a-1][b-1]},row:function(a){return a>this.elements.length?null:l.create(this.elements[a-1])},col:function(a){if(a>this.elements[0].length)return null;
var b=[],c=this.elements.length,d=c,g;do g=d-c,b.push(this.elements[g][a-1]);while(--c);return l.create(b)},dimensions:function(){return{rows:this.elements.length,cols:this.elements[0].length}},rows:function(){return this.elements.length},cols:function(){return this.elements[0].length},eql:function(a){a=a.elements||a;if(typeof a[0][0]=="undefined")a=n.create(a).elements;if(this.elements.length!=a.length||this.elements[0].length!=a[0].length)return false;var b=this.elements.length,c=b,d,g,h=this.elements[0].length,
k;do{d=c-b;g=h;do if(k=h-g,Math.abs(this.elements[d][k]-a[d][k])>1.0E-6)return false;while(--g)}while(--b);return true},dup:function(){return n.create(this.elements)},map:function(a){var b=[],c=this.elements.length,d=c,g,h,k=this.elements[0].length,m;do{g=d-c;h=k;b[g]=[];do m=k-h,b[g][m]=a(this.elements[g][m],g+1,m+1);while(--h)}while(--c);return n.create(b)},isSameSizeAs:function(a){a=a.elements||a;if(typeof a[0][0]=="undefined")a=n.create(a).elements;return this.elements.length==a.length&&this.elements[0].length==
a[0].length},add:function(a){var b=a.elements||a;if(typeof b[0][0]=="undefined")b=n.create(b).elements;return!this.isSameSizeAs(b)?null:this.map(function(a,d,g){return a+b[d-1][g-1]})},subtract:function(a){var b=a.elements||a;if(typeof b[0][0]=="undefined")b=n.create(b).elements;return!this.isSameSizeAs(b)?null:this.map(function(a,d,g){return a-b[d-1][g-1]})},canMultiplyFromLeft:function(a){a=a.elements||a;if(typeof a[0][0]=="undefined")a=n.create(a).elements;return this.elements[0].length==a.length},
multiply:function(a){if(!a.elements)return this.map(function(b){return b*a});var b=a.modulus?true:false,c=a.elements||a;if(typeof c[0][0]=="undefined")c=n.create(c).elements;if(!this.canMultiplyFromLeft(c))return null;var d=this.elements.length,g=d,h,k,m=c[0].length,l,u=this.elements[0].length,p=[],o,q,r;do{h=g-d;p[h]=[];k=m;do{l=m-k;o=0;q=u;do r=u-q,o+=this.elements[h][r]*c[r][l];while(--q);p[h][l]=o}while(--k)}while(--d);c=n.create(p);return b?c.col(1):c},x:function(a){return this.multiply(a)},
minor:function(a,b,c,d){var g=[],h=c,k,m,l,u=this.elements.length,p=this.elements[0].length;do{k=c-h;g[k]=[];m=d;do l=d-m,g[k][l]=this.elements[(a+k-1)%u][(b+l-1)%p];while(--m)}while(--h);return n.create(g)},transpose:function(){var a=this.elements.length,b=this.elements[0].length,c=[],d=b,g,h,k;do{g=b-d;c[g]=[];h=a;do k=a-h,c[g][k]=this.elements[k][g];while(--h)}while(--d);return n.create(c)},isSquare:function(){return this.elements.length==this.elements[0].length},max:function(){var a=0,b=this.elements.length,
c=b,d,g,h=this.elements[0].length,k;do{d=c-b;g=h;do k=h-g,Math.abs(this.elements[d][k])>Math.abs(a)&&(a=this.elements[d][k]);while(--g)}while(--b);return a},indexOf:function(a){var b=this.elements.length,c=b,d,g,h=this.elements[0].length,k;do{d=c-b;g=h;do if(k=h-g,this.elements[d][k]==a)return{i:d+1,j:k+1};while(--g)}while(--b);return null},diagonal:function(){if(!this.isSquare)return null;var a=[],b=this.elements.length,c=b,d;do d=c-b,a.push(this.elements[d][d]);while(--b);return l.create(a)},toRightTriangular:function(){var a=
this.dup(),b,c=this.elements.length,d=c,g,h,k=this.elements[0].length,m;do{g=d-c;if(a.elements[g][g]==0)for(j=g+1;j<d;j++)if(a.elements[j][g]!=0){b=[];h=k;do m=k-h,b.push(a.elements[g][m]+a.elements[j][m]);while(--h);a.elements[g]=b;break}if(a.elements[g][g]!=0)for(j=g+1;j<d;j++){var l=a.elements[j][g]/a.elements[g][g];b=[];h=k;do m=k-h,b.push(m<=g?0:a.elements[j][m]-a.elements[g][m]*l);while(--h);a.elements[j]=b}}while(--c);return a},toUpperTriangular:function(){return this.toRightTriangular()},
determinant:function(){if(!this.isSquare())return null;var a=this.toRightTriangular(),b=a.elements[0][0],c=a.elements.length-1,d=c,g;do g=d-c+1,b*=a.elements[g][g];while(--c);return b},det:function(){return this.determinant()},isSingular:function(){return this.isSquare()&&this.determinant()===0},trace:function(){if(!this.isSquare())return null;var a=this.elements[0][0],b=this.elements.length-1,c=b,d;do d=c-b+1,a+=this.elements[d][d];while(--b);return a},tr:function(){return this.trace()},rank:function(){var a=
this.toRightTriangular(),b=0,c=this.elements.length,d=c,g,h,k=this.elements[0].length,m;do{g=d-c;h=k;do if(m=k-h,Math.abs(a.elements[g][m])>1.0E-6){b++;break}while(--h)}while(--c);return b},rk:function(){return this.rank()},augment:function(a){a=a.elements||a;if(typeof a[0][0]=="undefined")a=n.create(a).elements;var b=this.dup(),c=b.elements[0].length,d=b.elements.length,g=d,h,k,m=a[0].length,l;if(d!=a.length)return null;do{h=g-d;k=m;do l=m-k,b.elements[h][c+l]=a[h][l];while(--k)}while(--d);return b},
inverse:function(){if(!this.isSquare()||this.isSingular())return null;var a=this.elements.length,b=a,c,d,g=this.augment(n.I(a)).toRightTriangular(),h,k=g.elements[0].length,m,l,u=[],p;do{c=a-1;l=[];h=k;u[c]=[];d=g.elements[c][c];do m=k-h,p=g.elements[c][m]/d,l.push(p),m>=b&&u[c].push(p);while(--h);g.elements[c]=l;for(d=0;d<c;d++){l=[];h=k;do m=k-h,l.push(g.elements[d][m]-g.elements[c][m]*g.elements[d][c]);while(--h);g.elements[d]=l}}while(--a);return n.create(u)},inv:function(){return this.inverse()},
round:function(){return this.map(function(a){return Math.round(a)})},snapTo:function(a){return this.map(function(b){return Math.abs(b-a)<=1.0E-6?a:b})},inspect:function(){var a=[],b=this.elements.length,c=b,d;do d=c-b,a.push(l.create(this.elements[d]).inspect());while(--b);return a.join("\n")},setElements:function(a){var b=a.elements||a;if(typeof b[0][0]!="undefined"){var c=b.length,d=c,g,h,k;this.elements=[];do{a=d-c;h=g=b[a].length;this.elements[a]=[];do k=h-g,this.elements[a][k]=b[a][k];while(--g)}while(--c);
return this}d=c=b.length;this.elements=[];do a=d-c,this.elements.push([b[a]]);while(--c);return this}};n.create=function(a){return(new n).setElements(a)};n.I=function(a){var b=[],c=a,d,g,h;do{d=c-a;b[d]=[];g=c;do h=c-g,b[d][h]=d==h?1:0;while(--g)}while(--a);return n.create(b)};n.Diagonal=function(a){var b=a.length,c=b,d,g=n.I(b);do d=c-b,g.elements[d][d]=a[d];while(--b);return g};n.Rotation=function(a,b){if(!b)return n.create([[Math.cos(a),-Math.sin(a)],[Math.sin(a),Math.cos(a)]]);var c=b.dup();if(c.elements.length!=
3)return null;var d=c.modulus(),g=c.elements[0]/d,h=c.elements[1]/d,c=c.elements[2]/d,d=Math.sin(a),k=Math.cos(a),m=1-k;return n.create([[m*g*g+k,m*g*h-d*c,m*g*c+d*h],[m*g*h+d*c,m*h*h+k,m*h*c-d*g],[m*g*c-d*h,m*h*c+d*g,m*c*c+k]])};n.RotationX=function(a){var b=Math.cos(a),a=Math.sin(a);return n.create([[1,0,0],[0,b,-a],[0,a,b]])};n.RotationY=function(a){var b=Math.cos(a),a=Math.sin(a);return n.create([[b,0,a],[0,1,0],[-a,0,b]])};n.RotationZ=function(a){var b=Math.cos(a),a=Math.sin(a);return n.create([[b,
-a,0],[a,b,0],[0,0,1]])};n.Random=function(a,b){return n.Zero(a,b).map(function(){return Math.random()})};n.Zero=function(a,b){var c=[],d=a,g,h,k;do{g=a-d;c[g]=[];h=b;do k=b-h,c[g][k]=0;while(--h)}while(--d);return n.create(c)};r.prototype={eql:function(a){return this.isParallelTo(a)&&this.contains(a.anchor)},dup:function(){return r.create(this.anchor,this.direction)},translate:function(a){a=a.elements||a;return r.create([this.anchor.elements[0]+a[0],this.anchor.elements[1]+a[1],this.anchor.elements[2]+
(a[2]||0)],this.direction)},isParallelTo:function(a){if(a.normal)return a.isParallelTo(this);a=this.direction.angleFrom(a.direction);return Math.abs(a)<=1.0E-6||Math.abs(a-Math.PI)<=1.0E-6},distanceFrom:function(a){if(a.normal)return a.distanceFrom(this);if(a.direction){if(this.isParallelTo(a))return this.distanceFrom(a.anchor);var b=this.direction.cross(a.direction).toUnitVector().elements,c=this.anchor.elements,a=a.anchor.elements;return Math.abs((c[0]-a[0])*b[0]+(c[1]-a[1])*b[1]+(c[2]-a[2])*b[2])}else{var d=
a.elements||a,c=this.anchor.elements,b=this.direction.elements,a=d[0]-c[0],g=d[1]-c[1],d=(d[2]||0)-c[2],c=Math.sqrt(a*a+g*g+d*d);if(c===0)return 0;b=(a*b[0]+g*b[1]+d*b[2])/c;b=1-b*b;return Math.abs(c*Math.sqrt(b<0?0:b))}},contains:function(a){a=this.distanceFrom(a);return a!==null&&a<=1.0E-6},liesIn:function(a){return a.contains(this)},intersects:function(a){return a.normal?a.intersects(this):!this.isParallelTo(a)&&this.distanceFrom(a)<=1.0E-6},intersectionWith:function(a){if(a.normal)return a.intersectionWith(this);
if(!this.intersects(a))return null;var b=this.anchor.elements,c=this.direction.elements,d=a.anchor.elements,g=a.direction.elements,a=c[0],h=c[1],c=c[2],k=g[0],m=g[1],g=g[2],n=b[0]-d[0],p=b[1]-d[1],d=b[2]-d[2],o=k*k+m*m+g*g,q=a*k+h*m+c*g,k=((-a*n-h*p-c*d)*o/(a*a+h*h+c*c)+q*(k*n+m*p+g*d))/(o-q*q);return l.create([b[0]+k*a,b[1]+k*h,b[2]+k*c])},pointClosestTo:function(a){if(a.direction){if(this.intersects(a))return this.intersectionWith(a);if(this.isParallelTo(a))return null;var b=this.direction.elements,
c=a.direction.elements,d=b[0],g=b[1],b=b[2],h=c[0],k=c[1],m=c[2],c=b*h-d*m,n=d*k-g*h,o=g*m-b*k,d=l.create([c*m-n*k,n*h-o*m,o*k-c*h]),a=p.create(a.anchor,d);return a.intersectionWith(this)}else{a=a.elements||a;if(this.contains(a))return l.create(a);c=this.anchor.elements;b=this.direction.elements;d=b[0];g=b[1];b=b[2];h=c[0];n=c[1];k=c[2];c=d*(a[1]-n)-g*(a[0]-h);n=g*((a[2]||0)-k)-b*(a[1]-n);o=b*(a[0]-h)-d*((a[2]||0)-k);d=l.create([g*c-b*o,b*n-d*c,d*o-g*n]);g=this.distanceFrom(a)/d.modulus();return l.create([a[0]+
d.elements[0]*g,a[1]+d.elements[1]*g,(a[2]||0)+d.elements[2]*g])}},rotate:function(a,b){typeof b.direction=="undefined"&&(b=r.create(b.to3D(),l.k));var c=n.Rotation(a,b.direction).elements,d=b.pointClosestTo(this.anchor).elements,g=this.anchor.elements,h=this.direction.elements,k=d[0],m=d[1],d=d[2],p=g[0]-k,o=g[1]-m,g=g[2]-d;return r.create([k+c[0][0]*p+c[0][1]*o+c[0][2]*g,m+c[1][0]*p+c[1][1]*o+c[1][2]*g,d+c[2][0]*p+c[2][1]*o+c[2][2]*g],[c[0][0]*h[0]+c[0][1]*h[1]+c[0][2]*h[2],c[1][0]*h[0]+c[1][1]*
h[1]+c[1][2]*h[2],c[2][0]*h[0]+c[2][1]*h[1]+c[2][2]*h[2]])},reflectionIn:function(a){if(a.normal){var b=this.anchor.elements,c=this.direction.elements,d=b[0],g=b[1],b=b[2],h=c[0],k=c[1],m=c[2],c=this.anchor.reflectionIn(a).elements;d+=h;g+=k;b+=m;a=a.pointClosestTo([d,g,b]).elements;return r.create(c,[a[0]+(a[0]-d)-c[0],a[1]+(a[1]-g)-c[1],a[2]+(a[2]-b)-c[2]])}else return a.direction?this.rotate(Math.PI,a):(a=a.elements||a,r.create(this.anchor.reflectionIn([a[0],a[1],a[2]||0]),this.direction))},setVectors:function(a,
b){a=l.create(a);b=l.create(b);a.elements.length==2&&a.elements.push(0);b.elements.length==2&&b.elements.push(0);if(a.elements.length>3||b.elements.length>3)return null;var c=b.modulus();if(c===0)return null;this.anchor=a;this.direction=l.create([b.elements[0]/c,b.elements[1]/c,b.elements[2]/c]);return this}};r.create=function(a,b){return(new r).setVectors(a,b)};r.X=r.create(l.Zero(3),l.i);r.Y=r.create(l.Zero(3),l.j);r.Z=r.create(l.Zero(3),l.k);p.prototype={eql:function(a){return this.contains(a.anchor)&&
this.isParallelTo(a)},dup:function(){return p.create(this.anchor,this.normal)},translate:function(a){a=a.elements||a;return p.create([this.anchor.elements[0]+a[0],this.anchor.elements[1]+a[1],this.anchor.elements[2]+(a[2]||0)],this.normal)},isParallelTo:function(a){if(a.normal)return a=this.normal.angleFrom(a.normal),Math.abs(a)<=1.0E-6||Math.abs(Math.PI-a)<=1.0E-6;else if(a.direction)return this.normal.isPerpendicularTo(a.direction);return null},isPerpendicularTo:function(a){a=this.normal.angleFrom(a.normal);
return Math.abs(Math.PI/2-a)<=1.0E-6},distanceFrom:function(a){if(this.intersects(a)||this.contains(a))return 0;if(a.anchor){var b=this.anchor.elements,c=a.anchor.elements,a=this.normal.elements;return Math.abs((b[0]-c[0])*a[0]+(b[1]-c[1])*a[1]+(b[2]-c[2])*a[2])}else return c=a.elements||a,b=this.anchor.elements,a=this.normal.elements,Math.abs((b[0]-c[0])*a[0]+(b[1]-c[1])*a[1]+(b[2]-(c[2]||0))*a[2])},contains:function(a){if(a.normal)return null;if(a.direction)return this.contains(a.anchor)&&this.contains(a.anchor.add(a.direction));
else{var a=a.elements||a,b=this.anchor.elements,c=this.normal.elements;return Math.abs(c[0]*(b[0]-a[0])+c[1]*(b[1]-a[1])+c[2]*(b[2]-(a[2]||0)))<=1.0E-6}},intersects:function(a){return typeof a.direction=="undefined"&&typeof a.normal=="undefined"?null:!this.isParallelTo(a)},intersectionWith:function(a){if(!this.intersects(a))return null;if(a.direction){var b=a.anchor.elements,c=a.direction.elements,a=this.anchor.elements,d=this.normal.elements,a=(d[0]*(a[0]-b[0])+d[1]*(a[1]-b[1])+d[2]*(a[2]-b[2]))/
(d[0]*c[0]+d[1]*c[1]+d[2]*c[2]);return l.create([b[0]+c[0]*a,b[1]+c[1]*a,b[2]+c[2]*a])}else if(a.normal){for(var c=this.normal.cross(a.normal).toUnitVector(),d=this.normal.elements,b=this.anchor.elements,g=a.normal.elements,h=a.anchor.elements,k=n.Zero(2,2),a=0;k.isSingular();)a++,k=n.create([[d[a%3],d[(a+1)%3]],[g[a%3],g[(a+1)%3]]]);k=k.inverse().elements;b=d[0]*b[0]+d[1]*b[1]+d[2]*b[2];d=g[0]*h[0]+g[1]*h[1]+g[2]*h[2];b=[k[0][0]*b+k[0][1]*d,k[1][0]*b+k[1][1]*d];d=[];for(g=1;g<=3;g++)d.push(a==g?
0:b[(g+(5-a)%3)%3]);return r.create(d,c)}},pointClosestTo:function(a){var a=a.elements||a,b=this.anchor.elements,c=this.normal.elements,b=(b[0]-a[0])*c[0]+(b[1]-a[1])*c[1]+(b[2]-(a[2]||0))*c[2];return l.create([a[0]+c[0]*b,a[1]+c[1]*b,(a[2]||0)+c[2]*b])},rotate:function(a,b){var c=n.Rotation(a,b.direction).elements,d=b.pointClosestTo(this.anchor).elements,g=this.anchor.elements,h=this.normal.elements,k=d[0],m=d[1],d=d[2],l=g[0]-k,o=g[1]-m,g=g[2]-d;return p.create([k+c[0][0]*l+c[0][1]*o+c[0][2]*g,
m+c[1][0]*l+c[1][1]*o+c[1][2]*g,d+c[2][0]*l+c[2][1]*o+c[2][2]*g],[c[0][0]*h[0]+c[0][1]*h[1]+c[0][2]*h[2],c[1][0]*h[0]+c[1][1]*h[1]+c[1][2]*h[2],c[2][0]*h[0]+c[2][1]*h[1]+c[2][2]*h[2]])},reflectionIn:function(a){if(a.normal){var b=this.anchor.elements,c=this.normal.elements,d=b[0],g=b[1],b=b[2],h=c[0],k=c[1],l=c[2],c=this.anchor.reflectionIn(a).elements;d+=h;g+=k;b+=l;a=a.pointClosestTo([d,g,b]).elements;return p.create(c,[a[0]+(a[0]-d)-c[0],a[1]+(a[1]-g)-c[1],a[2]+(a[2]-b)-c[2]])}else return a.direction?
this.rotate(Math.PI,a):(a=a.elements||a,p.create(this.anchor.reflectionIn([a[0],a[1],a[2]||0]),this.normal))},setVectors:function(a,b,c){a=l.create(a);a=a.to3D();if(a===null)return null;b=l.create(b);b=b.to3D();if(b===null)return null;if(typeof c=="undefined")c=null;else if(c=l.create(c),c=c.to3D(),c===null)return null;var d=a.elements[0],g=a.elements[1],h=a.elements[2],k=b.elements[0],m=b.elements[1],n=b.elements[2];if(c!==null){var b=c.elements[0],o=c.elements[1],c=c.elements[2],g=l.create([(m-
g)*(c-h)-(n-h)*(o-g),(n-h)*(b-d)-(k-d)*(c-h),(k-d)*(o-g)-(m-g)*(b-d)]),d=g.modulus();if(d===0)return null;g=l.create([g.elements[0]/d,g.elements[1]/d,g.elements[2]/d])}else{d=Math.sqrt(k*k+m*m+n*n);if(d===0)return null;g=l.create([b.elements[0]/d,b.elements[1]/d,b.elements[2]/d])}this.anchor=a;this.normal=g;return this}};p.create=function(a,b,c){return(new p).setVectors(a,b,c)};p.XY=p.create(l.Zero(3),l.k);p.YZ=p.create(l.Zero(3),l.i);p.ZX=p.create(l.Zero(3),l.j);p.YX=p.XY;p.ZY=p.YZ;p.XZ=p.ZX;var y=
l.create,A=n.create,G=function(a){a.m=new t;a.x=new s(a);a.util=new C(a)},H=function(a){var b=null;try{(b=a.getContext("webgl"))||(b=a.getContext("experimental-webgl"))}catch(c){alert("Error creating webgl context: "+c)}b||alert("Failed to create webgl context.");return b};v.fn.gl=function(a){if(this.length==0)return this;var b=this[0],c=null;if(b._jquery_gl)if(c=b._jquery_gl,a)alert("Re-wrapping a wrapped gl context not supported.");else return c;else c=H(this[0]),b._jquery_gl=c;G(c);a&&(a.init&&
a.init(c),a.draw&&(c.x.draw(a.draw),a.draw(c)),a.update&&c.x.update(a.update),a.framerate&&a.framerate>0&&setInterval(function(){c.x.frame()},1E3/a.framerate));c.x.info=F;return c}})(jQuery);